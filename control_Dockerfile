FROM ubuntu:22.04

# used to choose the default answers i.e. avoids prompting you yes or no
ARG DEBIAN_FRONTEND=noninteractive
ARG USERNAME
ARG PASSWORD
ARG SSH_KEY

# install required packages for ansible
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y \
    less \
    software-properties-common \
    python3 \
    python3-pip \
    openssh-client \
    iputils-ping \
    sshpass && \
    apt-get clean

# Create a non-root user for better security
RUN useradd -m -s /bin/bash ${USERNAME} && \
usermod -aG sudo ${USERNAME}

# Switch to the ansible user
USER ${USERNAME}

# Set the working directory
WORKDIR /home/${USERNAME}

# copy inventory file
COPY --chown=${USERNAME} inventory.yaml /home/${USERNAME}

# copy the ssh files
COPY --chown=${USERNAME} ${SSH_KEY}.pub ${SSH_KEY} /home/${USERNAME}/.ssh/

# editing environment variables
## add the home directory to the path
ENV PATH="/home/${USERNAME}/.local/bin:${PATH}"
## exporting locale so that ansible works
ENV LC_ALL=C.UTF-8

# install PyYAML
RUN python3 -m pip install pyyaml
# install ansible
RUN python3 -m pip install --user ansible

# # create ssh keys automatically (non-interactive)
# RUN ssh-keygen -t ed25519 -C "control node" -f /home/${USERNAME}/.ssh/${SSH_KEY} -N ""

CMD ["/bin/bash"]
